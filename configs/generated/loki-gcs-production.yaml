auth_enabled: true

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info
  log_format: json
  http_server_read_timeout: 45s
  http_server_write_timeout: 45s

common:
  instance_addr: 0.0.0.0
  path_prefix: /loki
  storage:
    gcs:
      bucket_name: ${GCS_BUCKET}
      service_account: ${GCS_SERVICE_ACCOUNT}
  replication_factor: 3
  ring:
    kvstore:
      store: etcd
      etcd:
        endpoints:
          - ${ETCD_ENDPOINT_1:-etcd-1:2379}
          - ${ETCD_ENDPOINT_2:-etcd-2:2379}
          - ${ETCD_ENDPOINT_3:-etcd-3:2379}
        dial_timeout: 10s

ingester:
  lifecycler:
    address: 0.0.0.0
    ring:
      kvstore:
        store: etcd
      replication_factor: 3
    final_sleep: 30s
  chunk_encoding: snappy
  chunk_idle_period: 45m
  chunk_retain_period: 2m
  wal:
    enabled: true
    dir: /loki/wal
    replay_memory_ceiling: 3GB
  concurrent_flushes: 48
  max_chunk_age: 3h
  flush_on_shutdown: true

distributor:
  ring:
    kvstore:
      store: etcd

frontend:
  max_outstanding_per_tenant: 768
  compress_responses: true

query_scheduler:
  max_outstanding_requests_per_tenant: 768

querier:
  max_concurrent: 48
  tail_max_duration: 1h
  extra_query_delay: 0s

schema_config:
  configs:
    - from: 2020-10-24
      store: tsdb
      object_store: gcs
      schema: v13
      index:
        prefix: index_
        period: 24h
      row_shards: 8

ruler:
  storage:
    type: gcs
  rule_path: /tmp/scratch
  alertmanager_url: ${ALERTMANAGER_URL:-http://alertmanager:9093}
  ring:
    kvstore:
      store: etcd
  enable_api: true
  enable_sharding: true

analytics:
  reporting_enabled: false

limits_config:
  ingestion_rate_mb: 200
  ingestion_burst_size_mb: 400
  max_streams_per_user: 75000
  max_line_size: 768KB
  max_entries_limit_per_query: 15000
  
  max_query_length: 12000h
  max_query_parallelism: 96
  max_query_series: 1500
  
  retention_period: 60d
  
  max_concurrent_tail_requests: 30
  max_cache_freshness_per_query: 12m
  
  reject_old_samples: true
  reject_old_samples_max_age: 432h
  
  creation_grace_period: 20m
  unordered_writes: true

compactor:
  working_directory: /tmp/loki/retention
  compaction_interval: 20m
  retention_enabled: true
  retention_delete_delay: 6h
  retention_delete_worker_count: 400
  delete_request_store: gcs
  apply_retention_interval: 3h


storage_config:
  gcs:
    bucket_name: ${GCS_BUCKET}
    service_account: ${GCS_SERVICE_ACCOUNT}
  tsdb_shipper:
    active_index_directory: /loki/tsdb-index
    cache_location: /loki/tsdb-cache
    cache_ttl: 36h
    shared_store: gcs

chunk_store_config:
  chunk_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 3072
      ttl: 90m
    memcached:
      addresses: ${MEMCACHED_ADDRESSES:-memcached:11211}
      timeout: 100ms
      expiration: 90m
  write_dedupe_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 768
      ttl: 90m

query_range:
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 1536
        ttl: 90m
      memcached:
        addresses: ${MEMCACHED_ADDRESSES:-memcached:11211}
        timeout: 100ms
        expiration: 90m
  cache_results: true
  max_retries: 12
  split_queries_by_interval: 18h

memberlist:
  node_name: ${HOSTNAME}
  bind_port: 7946
  join_members:
    - ${LOKI_MEMBERLIST_JOIN}
  abort_if_cluster_join_fails: true

tracing:
  enabled: true
  otlp:
    endpoint: ${OTLP_ENDPOINT:-otel-collector:4317}
    insecure: false
