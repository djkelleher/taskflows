auth_enabled: {{ auth_enabled | default(false) | lower }}

server:
  http_listen_port: {{ server.http_port | default(3100) }}
  grpc_listen_port: {{ server.grpc_port | default(9096) }}
  log_level: {{ server.log_level | default('info') }}
  log_format: {{ server.log_format | default('json') }}
  http_server_read_timeout: {{ server.read_timeout | default('30s') }}
  http_server_write_timeout: {{ server.write_timeout | default('30s') }}

common:
  instance_addr: {{ common.instance_addr | default('127.0.0.1') }}
  path_prefix: {{ common.path_prefix | default('/loki') }}
  storage:
{% if storage.backend == 'filesystem' %}
    filesystem:
      chunks_directory: {{ storage.filesystem.chunks_dir | default('/loki/chunks') }}
      rules_directory: {{ storage.filesystem.rules_dir | default('/loki/rules') }}
{% elif storage.backend == 's3' %}
    s3:
      endpoint: {{ storage.s3.endpoint }}
      bucketnames: {{ storage.s3.bucket }}
      region: {{ storage.s3.region | default('us-east-1') }}
      access_key_id: {{ storage.s3.access_key }}
      secret_access_key: {{ storage.s3.secret_key }}
      insecure: {{ storage.s3.insecure | default(false) | lower }}
      sse_encryption: {{ storage.s3.sse_encryption | default(false) | lower }}
      s3forcepathstyle: {{ storage.s3.force_path_style | default(true) | lower }}
{% elif storage.backend == 'gcs' %}
    gcs:
      bucket_name: {{ storage.gcs.bucket }}
      service_account: {{ storage.gcs.service_account | default('') }}
{% elif storage.backend == 'azure' %}
    azure:
      account_name: {{ storage.azure.account_name }}
      account_key: {{ storage.azure.account_key }}
      container_name: {{ storage.azure.container }}
      endpoint_suffix: {{ storage.azure.endpoint_suffix | default('blob.core.windows.net') }}
{% endif %}
  replication_factor: {{ common.replication_factor | default(1) }}
  ring:
    kvstore:
      store: {{ common.ring_store | default('inmemory') }}
{% if common.ring_store == 'consul' %}
      consul:
        host: {{ common.consul.host }}:{{ common.consul.port | default(8500) }}
        prefix: {{ common.consul.prefix | default('loki/') }}
{% elif common.ring_store == 'etcd' %}
      etcd:
        endpoints:
{% for endpoint in common.etcd.endpoints %}
          - {{ endpoint }}
{% endfor %}
        dial_timeout: {{ common.etcd.dial_timeout | default('10s') }}
{% endif %}

ingester:
  lifecycler:
    address: {{ ingester.address | default('127.0.0.1') }}
    ring:
      kvstore:
        store: {{ ingester.ring_store | default('inmemory') }}
      replication_factor: {{ ingester.replication_factor | default(1) }}
    final_sleep: {{ ingester.final_sleep | default('0s') }}
  chunk_encoding: {{ ingester.chunk_encoding | default('snappy') }}
  chunk_idle_period: {{ ingester.chunk_idle_period | default('5m') }}
  chunk_retain_period: {{ ingester.chunk_retain_period | default('30s') }}
  wal:
    enabled: {{ ingester.wal.enabled | default(true) | lower }}
{% if ingester.wal.enabled | default(true) %}
    dir: {{ ingester.wal.dir | default('/loki/wal') }}
    replay_memory_ceiling: {{ ingester.wal.replay_memory_ceiling | default('1GB') }}
{% endif %}
  concurrent_flushes: {{ ingester.concurrent_flushes | default(16) }}
  max_chunk_age: {{ ingester.max_chunk_age | default('2h') }}
{% if ingester.flush_on_shutdown is defined %}
  flush_on_shutdown: {{ ingester.flush_on_shutdown | lower }}
{% endif %}

distributor:
  ring:
    kvstore:
      store: {{ distributor.ring_store | default('inmemory') }}

frontend:
  max_outstanding_per_tenant: {{ frontend.max_outstanding | default(256) }}
  compress_responses: {{ frontend.compress_responses | default(true) | lower }}

query_scheduler:
  max_outstanding_requests_per_tenant: {{ query_scheduler.max_outstanding | default(256) }}

querier:
  max_concurrent: {{ querier.max_concurrent | default(16) }}
  tail_max_duration: {{ querier.tail_max_duration | default('1h') }}
  extra_query_delay: {{ querier.extra_query_delay | default('0s') }}

schema_config:
  configs:
    - from: {{ schema.from_date | default('2020-10-24') }}
      store: {{ schema.store | default('tsdb') }}
{% if storage.backend == 'filesystem' %}
      object_store: filesystem
{% elif storage.backend in ['s3', 'gcs', 'azure'] %}
      object_store: {{ storage.backend }}
{% endif %}
      schema: {{ schema.version | default('v13') }}
      index:
        prefix: {{ schema.index_prefix | default('index_') }}
        period: {{ schema.index_period | default('24h') }}
{% if schema.row_shards is defined %}
      row_shards: {{ schema.row_shards }}
{% endif %}

ruler:
  storage:
    type: {{ ruler.storage_type | default('local') }}
{% if ruler.storage_type == 'local' %}
    local:
      directory: {{ ruler.local_dir | default('/loki/rules') }}
{% elif ruler.storage_type == 's3' %}
    s3:
      endpoint: {{ storage.s3.endpoint }}
      bucketnames: {{ ruler.s3.bucket | default(storage.s3.bucket ~ '-rules') }}
      region: {{ storage.s3.region | default('us-east-1') }}
      access_key_id: {{ storage.s3.access_key }}
      secret_access_key: {{ storage.s3.secret_key }}
{% endif %}
  rule_path: {{ ruler.rule_path | default('/tmp/scratch') }}
{% if ruler.alertmanager_url is defined %}
  alertmanager_url: {{ ruler.alertmanager_url }}
{% endif %}
  ring:
    kvstore:
      store: {{ ruler.ring_store | default('inmemory') }}
  enable_api: {{ ruler.enable_api | default(true) | lower }}
  enable_sharding: {{ ruler.enable_sharding | default(false) | lower }}

analytics:
  reporting_enabled: {{ analytics.reporting_enabled | default(false) | lower }}

limits_config:
  ingestion_rate_mb: {{ limits.ingestion_rate_mb | default(64) }}
  ingestion_burst_size_mb: {{ limits.ingestion_burst_size_mb | default(128) }}
  max_streams_per_user: {{ limits.max_streams_per_user | default(10000) }}
  max_line_size: {{ limits.max_line_size | default('256KB') }}
  max_entries_limit_per_query: {{ limits.max_entries_limit_per_query | default(5000) }}
  
  max_query_length: {{ limits.max_query_length | default('12000h') }}
  max_query_parallelism: {{ limits.max_query_parallelism | default(32) }}
  max_query_series: {{ limits.max_query_series | default(500) }}
  
{% if retention.enabled %}
  retention_period: {{ retention.period }}
{% endif %}
  
  max_concurrent_tail_requests: {{ limits.max_concurrent_tail_requests | default(10) }}
  max_cache_freshness_per_query: {{ limits.max_cache_freshness_per_query | default('10m') }}
  
  reject_old_samples: {{ limits.reject_old_samples | default(true) | lower }}
  reject_old_samples_max_age: {{ limits.reject_old_samples_max_age | default('168h') }}
  
  creation_grace_period: {{ limits.creation_grace_period | default('10m') }}
  unordered_writes: {{ limits.unordered_writes | default(true) | lower }}

{% if retention.enabled %}
compactor:
  working_directory: {{ compactor.working_dir | default('/tmp/loki/retention') }}
  compaction_interval: {{ compactor.interval | default('10m') }}
  retention_enabled: true
  retention_delete_delay: {{ compactor.delete_delay | default('2h') }}
  retention_delete_worker_count: {{ compactor.delete_workers | default(150) }}
{% if storage.backend == 'filesystem' %}
  delete_request_store: filesystem
{% elif storage.backend in ['s3', 'gcs', 'azure'] %}
  delete_request_store: {{ storage.backend }}
{% endif %}
{% if compactor.apply_retention_interval is defined %}
  apply_retention_interval: {{ compactor.apply_retention_interval }}
{% endif %}
{% endif %}

{% if table_manager is defined and table_manager.enabled | default(false) %}
table_manager:
  retention_deletes_enabled: {{ retention.enabled | default(true) | lower }}
  retention_period: {{ retention.period | default('30d') }}
{% endif %}

storage_config:
{% if storage.backend == 'filesystem' %}
  filesystem:
    directory: {{ storage.filesystem.chunks_dir | default('/loki/chunks') }}
{% elif storage.backend == 's3' %}
  aws:
    endpoint: {{ storage.s3.endpoint }}
    bucketnames: {{ storage.s3.bucket }}
    region: {{ storage.s3.region | default('us-east-1') }}
    access_key_id: {{ storage.s3.access_key }}
    secret_access_key: {{ storage.s3.secret_key }}
    insecure: {{ storage.s3.insecure | default(false) | lower }}
    sse_encryption: {{ storage.s3.sse_encryption | default(false) | lower }}
    s3forcepathstyle: {{ storage.s3.force_path_style | default(true) | lower }}
{% elif storage.backend == 'gcs' %}
  gcs:
    bucket_name: {{ storage.gcs.bucket }}
    service_account: {{ storage.gcs.service_account | default('') }}
{% elif storage.backend == 'azure' %}
  azure:
    account_name: {{ storage.azure.account_name }}
    account_key: {{ storage.azure.account_key }}
    container_name: {{ storage.azure.container }}
    endpoint_suffix: {{ storage.azure.endpoint_suffix | default('blob.core.windows.net') }}
{% endif %}
{% if schema.store == 'tsdb' %}
  tsdb_shipper:
    active_index_directory: {{ storage.tsdb.active_index_dir | default('/loki/tsdb-index') }}
    cache_location: {{ storage.tsdb.cache_location | default('/loki/tsdb-cache') }}
    cache_ttl: {{ storage.tsdb.cache_ttl | default('24h') }}
{% if storage.backend != 'filesystem' %}
    shared_store: {{ storage.backend }}
{% endif %}
{% endif %}
{% if schema.store == 'boltdb-shipper' %}
  boltdb_shipper:
    active_index_directory: {{ storage.boltdb.active_index_dir | default('/loki/boltdb-index') }}
    cache_location: {{ storage.boltdb.cache_location | default('/loki/boltdb-cache') }}
    cache_ttl: {{ storage.boltdb.cache_ttl | default('24h') }}
{% if storage.backend != 'filesystem' %}
    shared_store: {{ storage.backend }}
{% endif %}
{% endif %}

chunk_store_config:
  chunk_cache_config:
{% if cache.chunk.enabled | default(true) %}
    embedded_cache:
      enabled: true
      max_size_mb: {{ cache.chunk.max_size_mb | default(1024) }}
      ttl: {{ cache.chunk.ttl | default('1h') }}
{% endif %}
{% if cache.chunk.redis is defined %}
    redis:
      endpoint: {{ cache.chunk.redis.endpoint }}
      password: {{ cache.chunk.redis.password | default('') }}
      db: {{ cache.chunk.redis.db | default(0) }}
      expiration: {{ cache.chunk.redis.expiration | default('1h') }}
{% elif cache.chunk.memcached is defined %}
    memcached:
      addresses: {{ cache.chunk.memcached.addresses }}
      timeout: {{ cache.chunk.memcached.timeout | default('100ms') }}
      expiration: {{ cache.chunk.memcached.expiration | default('1h') }}
{% endif %}
{% if cache.write_dedupe_enabled is defined %}
  write_dedupe_cache_config:
    embedded_cache:
      enabled: {{ cache.write_dedupe_enabled | lower }}
      max_size_mb: {{ cache.write_dedupe_max_size_mb | default(512) }}
      ttl: {{ cache.write_dedupe_ttl | default('1h') }}
{% endif %}

query_range:
  results_cache:
    cache:
{% if cache.query.enabled | default(true) %}
      embedded_cache:
        enabled: true
        max_size_mb: {{ cache.query.max_size_mb | default(512) }}
        ttl: {{ cache.query.ttl | default('1h') }}
{% endif %}
{% if cache.query.redis is defined %}
      redis:
        endpoint: {{ cache.query.redis.endpoint }}
        password: {{ cache.query.redis.password | default('') }}
        db: {{ cache.query.redis.db | default(0) }}
        expiration: {{ cache.query.redis.expiration | default('1h') }}
{% elif cache.query.memcached is defined %}
      memcached:
        addresses: {{ cache.query.memcached.addresses }}
        timeout: {{ cache.query.memcached.timeout | default('100ms') }}
        expiration: {{ cache.query.memcached.expiration | default('1h') }}
{% endif %}
  cache_results: {{ cache.query.cache_results | default(true) | lower }}
  max_retries: {{ query_range.max_retries | default(5) }}
{% if query_range.split_queries_by_interval is defined %}
  split_queries_by_interval: {{ query_range.split_queries_by_interval }}
{% endif %}

{% if memberlist is defined and memberlist.enabled | default(false) %}
memberlist:
  node_name: {{ memberlist.node_name | default('') }}
  bind_port: {{ memberlist.bind_port | default(7946) }}
  join_members:
{% for member in memberlist.join_members | default([]) %}
    - {{ member }}
{% endfor %}
  abort_if_cluster_join_fails: {{ memberlist.abort_if_join_fails | default(false) | lower }}
{% endif %}

tracing:
  enabled: {{ tracing.enabled | default(false) | lower }}
{% if tracing.enabled %}
{% if tracing.jaeger is defined %}
  jaeger:
    agent_host: {{ tracing.jaeger.agent_host }}
    agent_port: {{ tracing.jaeger.agent_port | default(6831) }}
    sampler_type: {{ tracing.jaeger.sampler_type | default('const') }}
    sampler_param: {{ tracing.jaeger.sampler_param | default(1) }}
{% elif tracing.otlp is defined %}
  otlp:
    endpoint: {{ tracing.otlp.endpoint }}
    insecure: {{ tracing.otlp.insecure | default(false) | lower }}
{% endif %}
{% endif %}