[SERVICE]
    # Fluent Bit core configuration
    Flush        1
    Log_Level    info
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020
    Parsers_File /fluent-bit/etc/parsers.conf

# Input: Systemd Journal for user services (UID 1000) - taskflows only
[INPUT]
    Name                systemd
    Tag                 user.*
    Systemd_Filter      _UID=1000
    Systemd_Filter      _SYSTEMD_USER_UNIT=taskflows-*.service
    Read_From_Tail      On
    Strip_Underscores   On
    DB                  /var/log/flb_user.db
    DB.Sync             Normal

# Input: Docker containers using journald driver (dl-services containers)
[INPUT]
    Name                systemd
    Tag                 docker.*
    Read_From_Tail      On
    Strip_Underscores   On
    DB                  /var/log/flb_docker.db
    DB.Sync             Normal

# Host service parser removed - not needed

# Unused parsers (commented out)
# [FILTER]
#     Name                parser
#     Match               app.logs
#     Key_Name            log
#     Parser              json_structlog
#     Reserve_Data        On

# Host service metadata filter removed - not needed

# Unused Docker filters (commented out)
# [FILTER]
#     Name                modify
#     Match               docker.*
#     Add                 service_type docker
#     Add                 environment production
#     Add                 log_source journald

# Filter: Add metadata for user services
[FILTER]
    Name                modify
    Match               user.*
    Add                 service_type user
    Add                 environment production
    Add                 log_source systemd

# Filter: Add metadata for Docker containers
[FILTER]
    Name                modify
    Match               docker.*
    Add                 service_type docker
    Add                 environment production
    Add                 log_source journald

# Filter: Exclude non-service logs (init.scope, etc)
[FILTER]
    Name                grep
    Match               user.*
    Regex               SYSTEMD_USER_UNIT ^taskflows-.*\.service$

# Filter: Extract service name from user systemd unit
[FILTER]
    Name                lua
    Match               user.*
    Script              /fluent-bit/etc/scripts/extract_user_service.lua
    Call                extract_service_name

# Filter: Extract service name from Docker container logs
[FILTER]
    Name                lua
    Match               docker.*
    Script              /fluent-bit/etc/scripts/extract_docker_service.lua
    Call                extract_docker_service_name

# Filter: Match Docker containers by SYSLOG_IDENTIFIER pattern
[FILTER]
    Name                grep
    Match               docker.*
    Regex               SYSLOG_IDENTIFIER ^docker\..*$

# Filter: Clean up user service logs - keep only essential fields
[FILTER]
    Name                record_modifier
    Match               user.*
    Whitelist_key       MESSAGE
    Whitelist_key       SYSTEMD_USER_UNIT
    Whitelist_key       service_name


# Filter: Clean up Docker container logs - keep only essential fields
[FILTER]
    Name                record_modifier
    Match               docker.*
    Whitelist_key       MESSAGE
    Whitelist_key       SYSLOG_IDENTIFIER
    Whitelist_key       container_name
    Whitelist_key       service_name

# Host service Lua filter removed - not needed

# Unused Lua filters (commented out)
# [FILTER]
#     Name                lua
#     Match               app.logs
#     Script              /fluent-bit/etc/scripts/extract_labels.lua
#     Call                extract_labels

# Output: Local file for debugging (disabled - causes errors)
# [OUTPUT]
#     Name                file
#     Match               *
#     Path                /var/log/fluent-bit
#     File                services-logs
#     Format              plain

# Output: Loki - User services (MESSAGE only)
[OUTPUT]
    Name                loki
    Match               user.*
    Host                ${LOKI_HOST}
    Port                ${LOKI_PORT}
    Labels              service_type=user,host=${HOSTNAME}
    Label_Keys          $SYSTEMD_USER_UNIT,$service_name
    Remove_Keys         SYSTEMD_USER_UNIT,service_name
    Drop_Single_Key     On
    Auto_Kubernetes_Labels  Off
    Retry_Limit         False
    HTTP_User           ${LOKI_USER}
    HTTP_Passwd         ${LOKI_PASSWORD}

# Output: Loki - Docker containers (MESSAGE only)
[OUTPUT]
    Name                loki
    Match               docker.*
    Host                ${LOKI_HOST}
    Port                ${LOKI_PORT}
    Labels              service_type=docker,host=${HOSTNAME}
    Label_Keys          $container_name,$service_name,$log_level,$log_module
    Remove_Keys         container_name,service_name,parsed_timestamp,log_timestamp,log_container,log_level,log_module,log_message
    Drop_Single_Key     On
    Auto_Kubernetes_Labels  Off
    Retry_Limit         False
    HTTP_User           ${LOKI_USER}
    HTTP_Passwd         ${LOKI_PASSWORD}

# Host service Loki output removed - not needed

# Output: Standard output for debugging
#[OUTPUT]
#    Name                stdout
#    Match               *
#    Format              json
