# Parser definitions for Fluent Bit
#
# USAGE NOTES:
# - Currently timestamp parsing is handled in Lua scripts for maximum flexibility
# - To use parsers instead of Lua for timestamp parsing:
#   1. Add a parser filter in fluent-bit.conf:
#      [FILTER]
#          Name                parser
#          Match               docker.*
#          Key_Name            MESSAGE
#          Parser              ib_logs
#          Preserve_Key        On
#          Reserve_Data        On
#   2. Remove timestamp parsing from extract_docker_service.lua
#   3. Parsers are faster than Lua but less flexible
#
# ACTIVE PARSERS (uncomment in fluent-bit.conf to use)

# Parser for IB log format - extracts timestamp and fields
[PARSER]
    Name                ib_logs
    Format              regex
    Regex               ^\[(?<log_container>[^\]]+)\]\s+\[(?<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\]\[(?<log_level>\w+)\]\[(?<log_module>\w+)\]\s+(?<log_message>.*)$
    Time_Key            timestamp
    Time_Format         %Y-%m-%d %H:%M:%S,%L
    Time_Keep           On

# Alternative parser for logs without the container prefix
[PARSER]
    Name                ib_logs_simple
    Format              regex
    Regex               ^\[(?<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\]\[(?<log_level>\w+)\]\[(?<log_module>\w+)\]\s+(?<log_message>.*)$
    Time_Key            timestamp
    Time_Format         %Y-%m-%d %H:%M:%S,%L
    Time_Keep           On

# UNUSED PARSERS (kept for potential future use)
# JSON parser for general log parsing
# [PARSER]
#     Name                json
#     Format              json
#     Time_Key            timestamp
#     Time_Format         %Y-%m-%dT%H:%M:%S.%LZ

# Docker JSON logs parser
# [PARSER]
#     Name                docker_json
#     Format              json
#     Time_Key            time
#     Time_Format         %Y-%m-%dT%H:%M:%S.%LZ

# Structlog JSON parser with escaped UTF-8 support
# [PARSER]
#     Name                json_structlog
#     Format              json
#     Time_Key            timestamp
#     Time_Format         %Y-%m-%dT%H:%M:%S.%L
#     Time_Keep           On
#     Decode_Field_As     escaped_utf8 message
#     Reserve_Data        On

# Syslog RFC3164 parser
[PARSER]
    Name                syslog_rfc3164
    Format              regex
    Regex               ^\<(?<priority>[0-9]+)\>(?<timestamp>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
    Time_Key            timestamp
    Time_Format         %b %d %H:%M:%S

# Alternative parsers (can be removed if not needed)
# [PARSER]
#     Name                services_simple
#     Format              regex
#     Regex               ^(?<level>\w+)\s+\[(?<service>[^\]]+)\]\s+(?<message>.*)$

# [PARSER]
#     Name                systemd
#     Format              regex
#     Regex               ^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\s+(?<level>\w+)\s+(?<message>.*)$
#     Time_Key            timestamp
#     Time_Format         %Y-%m-%dT%H:%M:%S.%LZ