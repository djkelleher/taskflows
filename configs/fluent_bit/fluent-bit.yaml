# Fluent Bit v4.2 YAML Configuration
# Collects logs from systemd user services via journald and Docker containers via fluentd forward protocol

service:
  flush: 5
  workers: 2
  log_level: info
  http_server: true
  http_listen: 0.0.0.0
  http_port: 2020
  parsers_file: /fluent-bit/etc/parsers.conf

pipeline:
  inputs:
    # Input: Systemd Journal for user services (UID 1000)
    # Note: systemd_filter does NOT support wildcards, so we filter only by UID
    # and let the Lua script filter for taskflows-*.service patterns
    - name: systemd
      tag: user_logs
      systemd_filter:
        - _UID=${SERVICE_UID}
      read_from_tail: true
      strip_underscores: true
      db: /var/log/flb_user.db
      db.sync: normal
      mem_buf_limit: 10MB

    # Input: Docker containers using fluentd driver via Forward protocol
    - name: forward
      tag: docker_logs
      listen: 0.0.0.0
      port: 24224
      buffer_chunk_size: 1M
      buffer_max_size: 6M

  filters:
    # Filter: Process all logs with Lua script
    - name: lua
      match: "*_logs"
      script: /fluent-bit/etc/scripts/log_processor.lua
      call: process_log

  outputs:
    # Output: Loki - All processed logs
    - name: loki
      match: "*_logs"
      host: ${LOKI_HOST}
      port: ${LOKI_PORT}
      labels: host=${HOSTNAME}
      label_keys: $service_name,$level,$environment
      remove_keys: service_name,level,environment
      auto_kubernetes_labels: false
      retry_limit: 5
      compress: gzip

    # Output: Standard output for debugging (disabled)
    # - name: stdout
    #   match: "*_logs"
    #   format: json_lines
